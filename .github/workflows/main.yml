name: UAT Frontend Deployment

on:
  workflow_dispatch:  # Manual trigger
  repository_dispatch:
    types: [trigger-uat-deploy]  # Trigger when the development branch is updated

env:
  IMAGE_TAG: "v${{ github.run_number }}"
  FRONTEND_IMAGE: "cloudgemsny/gemsny:uat-store-frontend-v${{ github.run_number }}"
  KUBECONFIG_FILE: "k8s/gemsny-uat.yaml"

jobs:
  deploy-frontend:
    runs-on: self-hosted      # Your self-hosted runner

    steps:
    - name: Checkout cicd-uat-config
      uses: actions/checkout@v3
      with:
        repository: gemsnyindia/cicd-uat-config
        ref: main
        token: ${{ secrets.UAT_TOKEN }}
        path: cicd-config

    - name: Checkout GemsnyStoreFE
      uses: actions/checkout@v3
      with:
        repository: gemsnyindia/GemsnyStoreFE
        ref: uat-staging
        token: ${{ secrets.UAT_TOKEN }}
        path: GemsnyStoreFE

    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USER }}
        password: ${{ secrets.DOCKER_PASS }}

    - name: Debug groups
      run: id

    - name: Build Frontend Docker Image
      working-directory: GemsnyStoreFE
      run: |
        # Load .env safely
        # set -o allexport
        # grep -v -E '^\s*#|^\s*$' /opt/config-env/frontendenv/.env | sed 's/\r$//' | while IFS='=' read -r key value; do
        #   export "$key=$value"
        # done
        # set +o allexport

        # Clean Windows-style line endings
        sed -i 's/\r$//' /opt/config-env/frontendenv/.env
        export $(grep -v '^#' /opt/config-env/frontendenv/.env | xargs)        



        # Build Docker image with all NEXT_PUBLIC_* args
        docker build \
          --build-arg NEXT_PUBLIC_TAG_MANAGER_ID=$NEXT_PUBLIC_TAG_MANAGER_ID \
          --build-arg NEXT_PUBLIC_LOCAL_URL=$NEXT_PUBLIC_LOCAL_URL \
          --build-arg NEXT_PUBLIC_IMAGES_CDN_PATH=$NEXT_PUBLIC_IMAGES_CDN_PATH \
          --build-arg NEXT_PUBLIC_CAPTCHA_KEY=$NEXT_PUBLIC_CAPTCHA_KEY \
          --build-arg NEXT_PUBLIC_AFFIRM=$NEXT_PUBLIC_AFFIRM \
          --build-arg NEXT_PUBLIC_LOCAL_ADMIN_URL=$NEXT_PUBLIC_LOCAL_ADMIN_URL \
          --build-arg NEXT_PUBLIC_BASIC_IMG=$NEXT_PUBLIC_BASIC_IMG \
          --build-arg NEXT_PUBLIC_BASE_URL=$NEXT_PUBLIC_BASE_URL \
          --build-arg NEXT_PUBLIC_GOOGLE_MAP_API_KEY=$NEXT_PUBLIC_GOOGLE_MAP_API_KEY \
          --build-arg NEXT_PUBLIC_AMAZON_PAY_PUBLIC_KEY_ID=$NEXT_PUBLIC_AMAZON_PAY_PUBLIC_KEY_ID \
          --build-arg NEXT_PUBLIC_AMAZON_PAY_STORE_ID=$NEXT_PUBLIC_AMAZON_PAY_STORE_ID \
          --build-arg NEXT_PUBLIC_AMAZON_PAY_MERCHANT_ID=$NEXT_PUBLIC_AMAZON_PAY_MERCHANT_ID \
          --build-arg NEXT_PUBLIC_AMAZON_PAY_REGION=$NEXT_PUBLIC_AMAZON_PAY_REGION \
          --build-arg NEXT_PUBLIC_AMAZON_PAY_SANDBOX=$NEXT_PUBLIC_AMAZON_PAY_SANDBOX \
          --build-arg NEXT_PUBLIC_PAYPAL_CLIENT_ID=$NEXT_PUBLIC_PAYPAL_CLIENT_ID \
          --build-arg NEXT_PUBLIC_PAYPAL_CLIENT_SECRET=$NEXT_PUBLIC_PAYPAL_CLIENT_SECRET \
          --build-arg NEXT_PUBLIC_PAYPAL_BASE_URL=$NEXT_PUBLIC_PAYPAL_BASE_URL \
          --build-arg NEXT_PUBLIC_AFFIRM_PUBLIC_KEY=$NEXT_PUBLIC_AFFIRM_PUBLIC_KEY \
          --build-arg NEXT_PUBLIC_AFFIRM_API_URL=$NEXT_PUBLIC_AFFIRM_API_URL \
          --build-arg NEXT_PUBLIC_AFFIRM_PRIVATE_KEY=$NEXT_PUBLIC_AFFIRM_PRIVATE_KEY \
          --build-arg NEXT_PUBLIC_PRODUCT_KEY=$NEXT_PUBLIC_PRODUCT_KEY \
          --build-arg NEXT_PUBLIC_MEILEI_SEARCH_HOST=$NEXT_PUBLIC_MEILEI_SEARCH_HOST \
          --build-arg NEXT_PUBLIC_MEILEI_SEARCH_API_KEY_FRONT=$NEXT_PUBLIC_MEILEI_SEARCH_API_KEY_FRONT \
          --build-arg NEXT_PUBLIC_ADMINPANEL_URL=$NEXT_PUBLIC_ADMINPANEL_URL \
          --build-arg NEXT_PUBLIC_EXTEND_ENVIRONMENT=$NEXT_PUBLIC_EXTEND_ENVIRONMENT \
          --build-arg NEXT_PUBLIC_EXTEND_STORE_ID=$NEXT_PUBLIC_EXTEND_STORE_ID \
          --build-arg NEXT_PUBLIC_BING_SCRIPT_ALLOW=$NEXT_PUBLIC_BING_SCRIPT_ALLOW \
          --build-arg NEXT_PUBLIC_ENVIRONMENT=$NEXT_PUBLIC_ENVIRONMENT \
          --build-arg NEXT_PUBLIC_SITE_URL=$NEXT_PUBLIC_SITE_URL \
          --build-arg NEXT_PUBLIC_AFFIRM_PUBLIC=$NEXT_PUBLIC_AFFIRM_PUBLIC \
          --build-arg NEXT_PUBLIC_EVENT_DELIVERY_NOTE_SHOW=$NEXT_PUBLIC_EVENT_DELIVERY_NOTE_SHOW \
          --build-arg NEXT_PUBLIC_MIN_LEAD_DAYS=$NEXT_PUBLIC_MIN_LEAD_DAYS \
          -t ${{ env.FRONTEND_IMAGE }} \
          -f ../cicd-config/Frontend/Dockerfile .

    - name: Push Frontend Docker Image
      run: docker push ${{ env.FRONTEND_IMAGE }}

    # - name: Load .env on Windows
    #   shell: powershell
    #   run: |
    #     $envFile = "D:\.env"

    #     if (!(Test-Path $envFile)) {
    #       Write-Error ".env file not found at $envFile"
    #       exit 1
    #     }

    #     # Normalize line endings
    #     (Get-Content $envFile) -replace "`r", "" | Set-Content $envFile

    #     # Load env vars into process
    #     Get-Content $envFile |
    #       Where-Object { $_ -and -not $_.StartsWith("#") } |
    #       ForEach-Object {
    #         $name, $value = $_ -split "=", 2
    #         [System.Environment]::SetEnvironmentVariable($name, $value, "Process")
    #       }


    # - name: Build Frontend Docker Image
    #   working-directory: GemsnyStoreFE
    #   shell: powershell
    #   run: |
    #     docker build `
    #       --build-arg NEXT_PUBLIC_TAG_MANAGER_ID=$env:NEXT_PUBLIC_TAG_MANAGER_ID `
    #       --build-arg NEXT_PUBLIC_LOCAL_URL=$env:NEXT_PUBLIC_LOCAL_URL `
    #       --build-arg NEXT_PUBLIC_IMAGES_CDN_PATH=$env:NEXT_PUBLIC_IMAGES_CDN_PATH `
    #       --build-arg NEXT_PUBLIC_CAPTCHA_KEY=$env:NEXT_PUBLIC_CAPTCHA_KEY `
    #       --build-arg NEXT_PUBLIC_AFFIRM=$env:NEXT_PUBLIC_AFFIRM `
    #       --build-arg NEXT_PUBLIC_LOCAL_ADMIN_URL=$env:NEXT_PUBLIC_LOCAL_ADMIN_URL `
    #       --build-arg NEXT_PUBLIC_BASIC_IMG=$env:NEXT_PUBLIC_BASIC_IMG `
    #       --build-arg NEXT_PUBLIC_BASE_URL=$env:NEXT_PUBLIC_BASE_URL `
    #       --build-arg NEXT_PUBLIC_GOOGLE_MAP_API_KEY=$env:NEXT_PUBLIC_GOOGLE_MAP_API_KEY `
    #       --build-arg NEXT_PUBLIC_AMAZON_PAY_PUBLIC_KEY_ID=$env:NEXT_PUBLIC_AMAZON_PAY_PUBLIC_KEY_ID `
    #       --build-arg NEXT_PUBLIC_AMAZON_PAY_STORE_ID=$env:NEXT_PUBLIC_AMAZON_PAY_STORE_ID `
    #       --build-arg NEXT_PUBLIC_AMAZON_PAY_MERCHANT_ID=$env:NEXT_PUBLIC_AMAZON_PAY_MERCHANT_ID `
    #       --build-arg NEXT_PUBLIC_AMAZON_PAY_REGION=$env:NEXT_PUBLIC_AMAZON_PAY_REGION `
    #       --build-arg NEXT_PUBLIC_AMAZON_PAY_SANDBOX=$env:NEXT_PUBLIC_AMAZON_PAY_SANDBOX `
    #       --build-arg NEXT_PUBLIC_PAYPAL_CLIENT_ID=$env:NEXT_PUBLIC_PAYPAL_CLIENT_ID `
    #       --build-arg NEXT_PUBLIC_PAYPAL_CLIENT_SECRET=$env:NEXT_PUBLIC_PAYPAL_CLIENT_SECRET `
    #       --build-arg NEXT_PUBLIC_PAYPAL_BASE_URL=$env:NEXT_PUBLIC_PAYPAL_BASE_URL `
    #       --build-arg NEXT_PUBLIC_AFFIRM_PUBLIC_KEY=$env:NEXT_PUBLIC_AFFIRM_PUBLIC_KEY `
    #       --build-arg NEXT_PUBLIC_AFFIRM_API_URL=$env:NEXT_PUBLIC_AFFIRM_API_URL `
    #       --build-arg NEXT_PUBLIC_AFFIRM_PRIVATE_KEY=$env:NEXT_PUBLIC_AFFIRM_PRIVATE_KEY `
    #       --build-arg NEXT_PUBLIC_PRODUCT_KEY=$env:NEXT_PUBLIC_PRODUCT_KEY `
    #       --build-arg NEXT_PUBLIC_MEILEI_SEARCH_HOST=$env:NEXT_PUBLIC_MEILEI_SEARCH_HOST `
    #       --build-arg NEXT_PUBLIC_MEILEI_SEARCH_API_KEY_FRONT=$env:NEXT_PUBLIC_MEILEI_SEARCH_API_KEY_FRONT `
    #       --build-arg NEXT_PUBLIC_ADMINPANEL_URL=$env:NEXT_PUBLIC_ADMINPANEL_URL `
    #       --build-arg NEXT_PUBLIC_EXTEND_ENVIRONMENT=$env:NEXT_PUBLIC_EXTEND_ENVIRONMENT `
    #       --build-arg NEXT_PUBLIC_EXTEND_STORE_ID=$env:NEXT_PUBLIC_EXTEND_STORE_ID `
    #       --build-arg NEXT_PUBLIC_BING_SCRIPT_ALLOW=$env:NEXT_PUBLIC_BING_SCRIPT_ALLOW `
    #       --build-arg NEXT_PUBLIC_ENVIRONMENT=$env:NEXT_PUBLIC_ENVIRONMENT `
    #       --build-arg NEXT_PUBLIC_SITE_URL=$env:NEXT_PUBLIC_SITE_URL `
    #       --build-arg NEXT_PUBLIC_AFFIRM_PUBLIC=$env:NEXT_PUBLIC_AFFIRM_PUBLIC `
    #       --build-arg NEXT_PUBLIC_EVENT_DELIVERY_NOTE_SHOW=$env:NEXT_PUBLIC_EVENT_DELIVERY_NOTE_SHOW `
    #       --build-arg NEXT_PUBLIC_MIN_LEAD_DAYS=$env:NEXT_PUBLIC_MIN_LEAD_DAYS `
    #       -t ${{ env.FRONTEND_IMAGE }} `
    #       -f ../cicd-config/Frontend/Dockerfile .

    # - name: Push Frontend Docker Image
    #   run: docker push ${{ env.FRONTEND_IMAGE }}


  # =============================
  # Deploy to Kubernetes
  # =============================
  # deploy-to-k8s:
  #   runs-on: self-hosted   # Server B (Deploy Server)
  #   needs: deploy-frontend  # Run only after build completes
  #   steps:
  #   - name: Checkout cicd-uat-config
  #     uses: actions/checkout@v3
  #     with:
  #       repository: gemsnyindia/cicd-uat-config
  #       ref: uat-staging
  #       token: ${{ secrets.UAT_TOKEN }}
  #       path: cicd-config

    - name: Deploy Frontend to Kubernetes
      working-directory: cicd-config
      env:
        DOCKER_USER: ${{ secrets.DOCKER_USER }}
        DOCKER_PASS: ${{ secrets.DOCKER_PASS }}
      run: |
        # Remove old Docker secret
        /var/lib/rancher/rke2/bin/kubectl --kubeconfig=${KUBECONFIG_FILE} delete secret dockerhub-secret --ignore-not-found

        # Create new Docker secret
        /var/lib/rancher/rke2/bin/kubectl --kubeconfig=${KUBECONFIG_FILE} create secret docker-registry dockerhub-secret \
          --docker-username=$DOCKER_USER \
          --docker-password=$DOCKER_PASS \
          --docker-email=cloud@gemsny.in

        # Update frontend deployment image tag
        sed -i "s|cloudgemsny/gemsny:uat-store-frontend-.*|cloudgemsny/gemsny:uat-store-frontend-${IMAGE_TAG}|" ./k8s/frontend-deployment.yaml

        # Recreate frontend-env secret (only needed if you have private runtime vars)
        /var/lib/rancher/rke2/bin/kubectl --kubeconfig=${KUBECONFIG_FILE} delete secret frontend-env --ignore-not-found
        /var/lib/rancher/rke2/bin/kubectl --kubeconfig=${KUBECONFIG_FILE} create secret generic frontend-env \
          --from-env-file=/opt/config-env/frontendenv/.env

        # Apply Kubernetes manifests
        /var/lib/rancher/rke2/bin/kubectl --kubeconfig=${KUBECONFIG_FILE} apply -f ./k8s/frontend-deployment.yaml
        /var/lib/rancher/rke2/bin/kubectl --kubeconfig=${KUBECONFIG_FILE} apply -f ./k8s/frontend-service.yaml
